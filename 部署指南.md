# 企业财务账目录入与利润核算系统 - 部署指南

## 目录

1. [环境准备](#环境准备)
2. [打包步骤](#打包步骤)
3. [安装程序创建](#安装程序创建)
4. [部署方式](#部署方式)
5. [版本更新](#版本更新)
6. [常见问题](#常见问题)

## 环境准备

### 开发环境要求

* Windows 7/8/10/11 64位操作系统
* Python 3.8 - 3.10 64位
* pip 最新版本
* Git (可选，用于获取源码)
* 足够的磁盘空间 (建议至少500MB)

### 安装依赖工具

1. 确保Python已正确安装：

```bash
python --version  # 应显示 3.8.x 到 3.10.x
pip --version     # 应显示最新版本
```

2. 升级pip：

```bash
pip install --upgrade pip
```

3. 安装打包工具：

```bash
pip install pyinstaller==5.13.1 cx_Freeze==6.15.1
```

## 打包步骤

### 方法一：使用PyInstaller打包（推荐）

1. 进入项目根目录：

```bash
cd c:\Users\Administrator.DESKTOP-4SQD351\Desktop\期末作业
```

2. 安装项目依赖：

```bash
pip install -r requirements.txt
```

3. 使用PyInstaller打包：

```bash
pyinstaller --name="财务账目录入与利润核算系统" \
            --onefile \
            --windowed \
            --icon="src/resources/icons/app_icon.ico" \
            --add-data="src/resources;resources" \
            --hidden-import="PyQt5.sip" \
            --hidden-import="PyQt5.QtPrintSupport" \
            --hidden-import="matplotlib.backends.backend_qt5agg" \
            main.py
```

**打包说明：**
* `--name`：指定生成的可执行文件名称
* `--onefile`：生成单一可执行文件
* `--windowed`：不显示控制台窗口
* `--icon`：设置应用图标（需提供图标文件）
* `--add-data`：添加资源文件
* `--hidden-import`：指定需要包含的隐藏依赖

4. 打包完成后，可执行文件将位于`dist`目录中。

### 方法二：使用cx_Freeze打包

1. 创建`setup_cxfreeze.py`文件：

```python
# setup_cxfreeze.py
import sys
from cx_Freeze import setup, Executable
import os

# 设置Python路径
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# 基础配置
build_exe_options = {
    "packages": ["os", "sys", "PyQt5", "sqlite3", "matplotlib", "pandas"],
    "excludes": ["tkinter"],
    "include_files": ["src/resources"],
    "include_msvcr": True,
}

# 构建配置
setup(
    name="财务账目录入与利润核算系统",
    version="1.0.0",
    description="企业财务账目录入与利润核算系统",
    options={"build_exe": build_exe_options},
    executables=[Executable("main.py", base="Win32GUI", 
                          icon="src/resources/icons/app_icon.ico")]
)
```

2. 执行打包命令：

```bash
python setup_cxfreeze.py build
```

3. 打包完成后，程序文件将位于`build`目录中。

## 安装程序创建

### 使用Inno Setup创建安装包

1. 下载并安装Inno Setup：[https://jrsoftware.org/isdl.php](https://jrsoftware.org/isdl.php)

2. 创建Inno Setup脚本（`finance_system_installer.iss`）：

```iss
; 企业财务账目录入与利润核算系统安装脚本

[Setup]
AppName=企业财务账目录入与利润核算系统
AppVersion=1.0.0
AppPublisher=Finance System Team
AppPublisherURL=https://example.com/
DefaultDirName={pf}\企业财务账目录入与利润核算系统
DefaultGroupName=企业财务账目录入与利润核算系统
OutputDir=c:\Users\Administrator.DESKTOP-4SQD351\Desktop\期末作业\installer
OutputBaseFilename=财务系统安装包
SetupIconFile=src\resources\icons\app_icon.ico
Compression=lzma2
SolidCompression=yes

[Languages]
Name: "chinese"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "创建桌面快捷方式"; GroupDescription: "附加任务";

[Files]
Source: "dist\财务账目录入与利润核算系统.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "src\resources\*"; DestDir: "{app}\resources"; Flags: recursesubdirs

[Icons]
Name: "{group}\企业财务账目录入与利润核算系统"; Filename: "{app}\财务账目录入与利润核算系统.exe"
Name: "{group}\卸载"; Filename: "{uninstallexe}"
Name: "{commondesktop}\企业财务账目录入与利润核算系统"; Filename: "{app}\财务账目录入与利润核算系统.exe"; Tasks: desktopicon

[Run]
Filename: "{app}\财务账目录入与利润核算系统.exe"; Description: "启动企业财务账目录入与利润核算系统";

[UninstallDelete]
Type: filesandordirs; Name: "{app}\data"
Type: filesandordirs; Name: "{app}\logs"
```

3. 使用Inno Setup编译脚本，生成安装程序。

## 部署方式

### 单机部署

1. 分发安装包给用户
2. 用户双击运行安装程序
3. 按照安装向导完成安装
4. 从桌面快捷方式或开始菜单启动系统

### 企业内部部署

#### 1. 共享文件夹部署

1. 在文件服务器上创建共享文件夹
2. 放置安装包或可执行文件
3. 用户从共享文件夹运行程序

**注意：** 数据库文件将存储在本地，如需集中管理数据，请使用网络数据库。

#### 2. 集中部署方案（需要修改源代码）

1. 修改数据库连接为使用网络数据库（如SQL Server、MySQL等）
2. 修改`src/database/db_manager.py`中的数据库连接配置
3. 部署修改后的版本

## 版本更新

### 更新步骤

1. 备份当前系统数据（位于`data`目录）
2. 卸载旧版本系统
3. 安装新版本系统
4. 恢复数据备份

### 数据迁移

版本更新可能需要进行数据库结构迁移，系统内置了迁移功能：

1. 启动系统后，如检测到版本差异，会自动提示进行数据库迁移
2. 确认后系统将自动进行数据结构更新
3. 迁移完成后，系统将正常启动

## 常见问题

### 打包问题

1. **缺少DLL文件**
   - 问题：打包后运行程序提示缺少DLL文件
   - 解决：确保使用与系统兼容的Python版本，64位系统使用64位Python

2. **Matplotlib中文字体显示问题**
   - 问题：图表中文字显示为方块
   - 解决：确保在代码中正确配置了中文字体

3. **打包文件过大**
   - 问题：生成的可执行文件过大
   - 解决：使用`--exclude-module`排除不必要的模块，或使用`--onedir`模式而非`--onefile`

### 安装问题

1. **权限不足**
   - 问题：安装失败，提示权限不足
   - 解决：以管理员身份运行安装程序

2. **路径包含中文字符**
   - 问题：程序无法正常运行
   - 解决：确保安装路径不包含非ASCII字符

### 运行问题

1. **数据库错误**
   - 问题：提示数据库文件访问错误
   - 解决：检查数据文件夹权限，确保用户有读写权限

2. **内存不足**
   - 问题：处理大量数据时程序崩溃
   - 解决：增加系统内存，或分批处理数据

## 附录

### 资源文件准备

如需自定义图标和资源文件，请将其放在以下位置：

- 应用图标：`src/resources/icons/app_icon.ico`
- 其他图标：`src/resources/icons/`
- 样式文件：`src/resources/styles/`

### 环境变量配置

系统支持以下环境变量：

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| FINANCE_DATA_DIR | 数据存储目录 | 应用程序目录下的`data`文件夹 |
| FINANCE_LOG_LEVEL | 日志级别 | INFO |
| FINANCE_LOG_DIR | 日志存储目录 | 应用程序目录下的`logs`文件夹 |

### 自动启动配置

如需配置系统开机自动启动：

1. 创建快捷方式指向主程序
2. 将快捷方式复制到：`C:\Users\用户名\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`

---

© 2025 企业财务账目录入与利润核算系统开发团队